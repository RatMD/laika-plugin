"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("vue");const t=e.reactive({color:"#DE3163",active:!1,percent:0,timestamp:0});let o=null;function n(){function e(e=!1){o&&(window.clearInterval(o),o=null),(t.active||e)&&(t.percent=100,window.setTimeout(()=>{t.active=!1,t.percent=0},150))}return{state:t,start:function(){t.active=!0,t.percent=10,t.timestamp=Date.now(),o&&window.clearInterval(o),o=window.setInterval(()=>{t.active&&t.percent<90&&(t.percent+=Math.max(1,Math.round(.08*(90-t.percent))))},200)},done:e,fail:function(){e(!0)}}}const a=e.defineComponent({setup(t){const o=n();return()=>o.state.active?e.h("div",{class:"laika-progress-bar",style:{top:0,left:0,width:`${o.state.percent}%`,height:"0.2rem",position:"fixed",backgroundColor:`var(--laika-progress-bar, ${o.state.color})`,transition:"width 120ms linear",zIndex:99999}}):void 0}}),r=e.defineComponent({setup(t){const o=y();return()=>{const t=o.page?.content??"";return e.h("div",{innerHTML:t})}}}),i=e.defineComponent({props:{name:{type:String,required:!0}},slots:Object,setup(t,{slots:o}){const n=y();return()=>{if(!n.components||!(t.name in n.components))return null;const a=n.components[t.name]||void 0;if(!a)return null;const r=o.default?.({...a});return e.h("div",{},r??void 0)}}});function l(e){return e?.default??e}function s(e,t){return t.split(".").reduce((e,t)=>null==e?void 0:e[t],e)}function u(e,t,o){const n=t.split(".");if(0===n.length)return;const a=n[n.length-1];let r=e;for(let e=0;e<n.length-1;e++){const t=n[e];null!=r[t]&&"object"==typeof r[t]||(r[t]={}),r=r[t]}r[a]=o}const c=e.shallowRef(),p=e.shallowRef(),d=e.shallowRef(null),v=e.ref(void 0),m={payload:()=>{},page:()=>{},visit:async()=>{throw new Error("Laika runtime not ready")},request:async()=>{throw new Error("Laika runtime not ready")}},f=e.defineComponent({name:"Laika",props:{initialPayload:{type:Object,required:!0},initialComponent:{type:Object,required:!1},resolveComponent:{type:Function,required:!0},title:{type:Function,required:!1,default:e=>e}},setup({initialPayload:t,initialComponent:o,resolveComponent:r,title:i}){p.value=t,v.value=void 0;const f=n();async function h(e){const t=await fetch(e,{headers:{Accept:"application/json","X-Laika":"1","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(409===t.status){const e=t.headers.get("X-Laika-Location");throw e&&window.location.assign(e),new Error("Laika redirect")}if(!t.ok)throw window.location.assign(e),new Error("Navigation fallback");const o=(n=t.headers.get("X-Laika-Only"))?n.split(",").map(e=>e.trim()).filter(Boolean):[];var n;return{data:await t.json(),only:o}}async function y(t,o,n){const a=await r(t.page.component);c.value=e.markRaw(l(a)),n&&n.length&&p.value?p.value=function(e,t,o){const n={...e},a=new Set(o.filter(e=>!e.startsWith("shared.")));for(const e of a)e in t&&(n[e]=t[e]);const r=o.filter(e=>e.startsWith("shared."));if(r.length){n.shared={...n.shared??{}};for(const e of r){const o=s(t,e);void 0!==o&&u(n,e,o)}}return n}(p.value,t,n):p.value=t;const d=p.value?.page?.title;d&&(document.title=(i??(e=>e))(d)),v.value=o?v.value:Date.now()}return c.value=o?e.markRaw(l(o)):void 0,c.value||Promise.resolve(r(t.page.component)).then(t=>{c.value=e.markRaw(l(t))}).catch(console.error),m.payload=()=>p.value,m.page=()=>p.value?.page,m.visit=async(e,t)=>{f.start();try{t?.replace?history.replaceState({},"",e):history.pushState({},"",e);const{data:o,only:n}=await h(e);await y(o,t?.preserveState,n),f.done()}catch(e){console.error(e),f.fail()}},m.request=async(e,t)=>({handler:e,data:t}),m.setLayout=e=>{d.value=e},window.addEventListener("popstate",()=>window.location.reload()),()=>{if(!c.value||!p.value)return null;const t=p.value.page.props??{},o=e.h(c.value,{...t,key:v.value});let n;d.value&&(c.value.layout=d.value,d.value=null);const r=c.value.layout;if(r)if("function"==typeof r)n=r(e.h,o);else{n=(Array.isArray(r)?r:[r]).slice().reverse().reduce((o,n)=>e.h(n,{...t},()=>o),o)}else n=o;return e.h(e.Fragment,null,[e.h(a),n])}}}),h={install(e){Object.defineProperty(e.config.globalProperties,"$laika",{get:()=>m}),Object.defineProperty(e.config.globalProperties,"$payload",{get:()=>p.value})}};function y(){return e.reactive({component:e.computed(()=>c.value),layout:e.computed(()=>d.value),key:e.computed(()=>v.value),payload:e.computed(()=>p.value),version:e.computed(()=>p.value?.version),page:e.computed(()=>p.value?.page),shared:e.computed(()=>p.value?.shared),theme:e.computed(()=>p.value?.theme),components:e.computed(()=>p.value?.components),runtime:e.computed(()=>m)})}exports.PageComponent=i,exports.PageContent=r,exports.ProgressBar=a,exports.createLaikaApp=async function(e){const t=e.rootId?document.querySelector(e.rootId):document.querySelector(".app");if(!t)throw new Error(`Laika: root element not found (${e.rootId??".app"})`);const o=function(e='[data-laika="payload"]'){const t=document.head.querySelector(e);if(!t?.textContent?.trim())throw new Error("Laika: payload missing/empty");return JSON.parse(t.textContent)}(),n={initialPayload:o,initialComponent:l(await Promise.resolve(e.resolve(o.page.component))),resolveComponent:e.resolve,...e.title?{title:e.title}:{}};return e.setup({root:t,App:f,props:n,plugin:h,payload:o})},exports.default=void 0,exports.laikaPlugin=h,exports.useLaika=y;
//# sourceMappingURL=laika.cjs.map
