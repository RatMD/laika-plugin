!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue")):"function"==typeof define&&define.amd?define(["exports","vue"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Laika={},e.Vue)}(this,function(e,t){"use strict";const n=t.reactive({color:"#DE3163",active:!1,percent:0,timestamp:0});let o=null;function a(){function e(e=!1){o&&(window.clearInterval(o),o=null),(n.active||e)&&(n.percent=100,window.setTimeout(()=>{n.active=!1,n.percent=0},150))}return{state:n,start:function(){n.active=!0,n.percent=10,n.timestamp=Date.now(),o&&window.clearInterval(o),o=window.setInterval(()=>{n.active&&n.percent<90&&(n.percent+=Math.max(1,Math.round(.08*(90-n.percent))))},200)},done:e,fail:function(){e(!0)}}}const r=t.defineComponent({setup(e){const n=a();return()=>n.state.active?t.h("div",{class:"laika-progress-bar",style:{top:0,left:0,width:`${n.state.percent}%`,height:"0.2rem",position:"fixed",backgroundColor:`var(--laika-progress-bar, ${n.state.color})`,transition:"width 120ms linear",zIndex:99999}}):void 0}}),i=t.defineComponent({setup(e){const n=w();return()=>{const e=n.page?.content??"";return t.h("div",{innerHTML:e})}}}),l=t.defineComponent({props:{name:{type:String,required:!0}},slots:Object,setup(e,{slots:n}){const o=w();return()=>{if(!o.components||!(e.name in o.components))return null;const a=o.components[e.name]||void 0;if(!a)return null;const r=n.default?.({...a});return t.h("div",{},r??void 0)}}});function s(e){return e?.default??e}function u(e,t){return t.split(".").reduce((e,t)=>null==e?void 0:e[t],e)}function c(e,t,n){const o=t.split(".");if(0===o.length)return;const a=o[o.length-1];let r=e;for(let e=0;e<o.length-1;e++){const t=o[e];null!=r[t]&&"object"==typeof r[t]||(r[t]={}),r=r[t]}r[a]=n}const p=t.shallowRef(),d=t.shallowRef(),v=t.shallowRef(null),f=t.ref(void 0),m={payload:()=>{},page:()=>{},visit:async()=>{throw new Error("Laika runtime not ready")},request:async()=>{throw new Error("Laika runtime not ready")}},h=t.defineComponent({name:"Laika",props:{initialPayload:{type:Object,required:!0},initialComponent:{type:Object,required:!1},resolveComponent:{type:Function,required:!0},title:{type:Function,required:!1,default:e=>e}},setup({initialPayload:e,initialComponent:n,resolveComponent:o,title:i}){d.value=e,f.value=void 0;const l=a();async function h(e){const t=await fetch(e,{headers:{Accept:"application/json","X-Laika":"1","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(409===t.status){const e=t.headers.get("X-Laika-Location");throw e&&window.location.assign(e),new Error("Laika redirect")}if(!t.ok)throw window.location.assign(e),new Error("Navigation fallback");const n=(o=t.headers.get("X-Laika-Only"))?o.split(",").map(e=>e.trim()).filter(Boolean):[];var o;return{data:await t.json(),only:n}}async function y(e,n,a){const r=await o(e.page.component);p.value=t.markRaw(s(r)),a&&a.length&&d.value?d.value=function(e,t,n){const o={...e},a=new Set(n.filter(e=>!e.startsWith("shared.")));for(const e of a)e in t&&(o[e]=t[e]);const r=n.filter(e=>e.startsWith("shared."));if(r.length){o.shared={...o.shared??{}};for(const e of r){const n=u(t,e);void 0!==n&&c(o,e,n)}}return o}(d.value,e,a):d.value=e;const l=d.value?.page?.title;l&&(document.title=(i??(e=>e))(l)),f.value=n?f.value:Date.now()}return p.value=n?t.markRaw(s(n)):void 0,p.value||Promise.resolve(o(e.page.component)).then(e=>{p.value=t.markRaw(s(e))}).catch(console.error),m.payload=()=>d.value,m.page=()=>d.value?.page,m.visit=async(e,t)=>{l.start();try{t?.replace?history.replaceState({},"",e):history.pushState({},"",e);const{data:n,only:o}=await h(e);await y(n,t?.preserveState,o),l.done()}catch(e){console.error(e),l.fail()}},m.request=async(e,t)=>({handler:e,data:t}),m.setLayout=e=>{v.value=e},window.addEventListener("popstate",()=>window.location.reload()),()=>{if(!p.value||!d.value)return null;const e=d.value.page.props??{},n=t.h(p.value,{...e,key:f.value});let o;v.value&&(p.value.layout=v.value,v.value=null);const a=p.value.layout;if(a)if("function"==typeof a)o=a(t.h,n);else{o=(Array.isArray(a)?a:[a]).slice().reverse().reduce((n,o)=>t.h(o,{...e},()=>n),n)}else o=n;return t.h(t.Fragment,null,[t.h(r),o])}}}),y={install(e){Object.defineProperty(e.config.globalProperties,"$laika",{get:()=>m}),Object.defineProperty(e.config.globalProperties,"$payload",{get:()=>d.value})}};function w(){return t.reactive({component:t.computed(()=>p.value),layout:t.computed(()=>v.value),key:t.computed(()=>f.value),payload:t.computed(()=>d.value),version:t.computed(()=>d.value?.version),page:t.computed(()=>d.value?.page),shared:t.computed(()=>d.value?.shared),theme:t.computed(()=>d.value?.theme),components:t.computed(()=>d.value?.components),runtime:t.computed(()=>m)})}e.PageComponent=l,e.PageContent=i,e.ProgressBar=r,e.createLaikaApp=async function(e){const t=e.rootId?document.querySelector(e.rootId):document.querySelector(".app");if(!t)throw new Error(`Laika: root element not found (${e.rootId??".app"})`);const n=function(e='[data-laika="payload"]'){const t=document.head.querySelector(e);if(!t?.textContent?.trim())throw new Error("Laika: payload missing/empty");return JSON.parse(t.textContent)}(),o={initialPayload:n,initialComponent:s(await Promise.resolve(e.resolve(n.page.component))),resolveComponent:e.resolve,...e.title?{title:e.title}:{}};return e.setup({root:t,App:h,props:o,plugin:y,payload:n})},e.default=void 0,e.laikaPlugin=y,e.useLaika=w,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=laika.js.map
