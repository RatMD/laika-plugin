import{reactive as e,defineComponent as t,h as n,computed as a,shallowRef as o,ref as r,markRaw as i,Fragment as l}from"vue";const s=e({color:"#DE3163",active:!1,percent:0,timestamp:0});let u=null;function c(){function e(e=!1){u&&(window.clearInterval(u),u=null),(s.active||e)&&(s.percent=100,window.setTimeout(()=>{s.active=!1,s.percent=0},150))}return{state:s,start:function(){s.active=!0,s.percent=10,s.timestamp=Date.now(),u&&window.clearInterval(u),u=window.setInterval(()=>{s.active&&s.percent<90&&(s.percent+=Math.max(1,Math.round(.08*(90-s.percent))))},200)},done:e,fail:function(){e(!0)}}}const p=t({setup(e){const t=c();return()=>t.state.active?n("div",{class:"laika-progress-bar",style:{top:0,left:0,width:`${t.state.percent}%`,height:"0.2rem",position:"fixed",backgroundColor:`var(--laika-progress-bar, ${t.state.color})`,transition:"width 120ms linear",zIndex:99999}}):void 0}}),d=t({setup(e){const t=P();return()=>{const e=t.page?.content??"";return n("div",{innerHTML:e})}}}),v=t({props:{name:{type:String,required:!0}},slots:Object,setup(e,{slots:t}){const a=P();return()=>{if(!a.components||!(e.name in a.components))return null;const o=a.components[e.name]||void 0;if(!o)return null;const r=t.default?.({...o});return n("div",{},r??void 0)}}});function f(e){return e?.default??e}function m(e,t){return t.split(".").reduce((e,t)=>null==e?void 0:e[t],e)}function y(e,t,n){const a=t.split(".");if(0===a.length)return;const o=a[a.length-1];let r=e;for(let e=0;e<a.length-1;e++){const t=a[e];null!=r[t]&&"object"==typeof r[t]||(r[t]={}),r=r[t]}r[o]=n}const h=o(),w=o(),g=o(null),k=r(void 0),L={payload:()=>{},page:()=>{},visit:async()=>{throw new Error("Laika runtime not ready")},request:async()=>{throw new Error("Laika runtime not ready")}},b=t({name:"Laika",props:{initialPayload:{type:Object,required:!0},initialComponent:{type:Object,required:!1},resolveComponent:{type:Function,required:!0},title:{type:Function,required:!1,default:e=>e}},setup({initialPayload:e,initialComponent:t,resolveComponent:a,title:o}){w.value=e,k.value=void 0;const r=c();async function s(e){const t=await fetch(e,{headers:{Accept:"application/json","X-Laika":"1","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(409===t.status){const e=t.headers.get("X-Laika-Location");throw e&&window.location.assign(e),new Error("Laika redirect")}if(!t.ok)throw window.location.assign(e),new Error("Navigation fallback");const n=(a=t.headers.get("X-Laika-Only"))?a.split(",").map(e=>e.trim()).filter(Boolean):[];var a;return{data:await t.json(),only:n}}async function u(e,t,n){const r=await a(e.page.component);h.value=i(f(r)),n&&n.length&&w.value?w.value=function(e,t,n){const a={...e},o=new Set(n.filter(e=>!e.startsWith("shared.")));for(const e of o)e in t&&(a[e]=t[e]);const r=n.filter(e=>e.startsWith("shared."));if(r.length){a.shared={...a.shared??{}};for(const e of r){const n=m(t,e);void 0!==n&&y(a,e,n)}}return a}(w.value,e,n):w.value=e;const l=w.value?.page?.title;l&&(document.title=(o??(e=>e))(l)),k.value=t?k.value:Date.now()}return h.value=t?i(f(t)):void 0,h.value||Promise.resolve(a(e.page.component)).then(e=>{h.value=i(f(e))}).catch(console.error),L.payload=()=>w.value,L.page=()=>w.value?.page,L.visit=async(e,t)=>{r.start();try{t?.replace?history.replaceState({},"",e):history.pushState({},"",e);const{data:n,only:a}=await s(e);await u(n,t?.preserveState,a),r.done()}catch(e){console.error(e),r.fail()}},L.request=async(e,t)=>({handler:e,data:t}),L.setLayout=e=>{g.value=e},window.addEventListener("popstate",()=>window.location.reload()),()=>{if(!h.value||!w.value)return null;const e=w.value.page.props??{},t=n(h.value,{...e,key:k.value});let a;g.value&&(h.value.layout=g.value,g.value=null);const o=h.value.layout;if(o)if("function"==typeof o)a=o(n,t);else{a=(Array.isArray(o)?o:[o]).slice().reverse().reduce((t,a)=>n(a,{...e},()=>t),t)}else a=t;return n(l,null,[n(p),a])}}}),q={install(e){Object.defineProperty(e.config.globalProperties,"$laika",{get:()=>L}),Object.defineProperty(e.config.globalProperties,"$payload",{get:()=>w.value})}};function P(){return e({component:a(()=>h.value),layout:a(()=>g.value),key:a(()=>k.value),payload:a(()=>w.value),version:a(()=>w.value?.version),page:a(()=>w.value?.page),shared:a(()=>w.value?.shared),theme:a(()=>w.value?.theme),components:a(()=>w.value?.components),runtime:a(()=>L)})}async function C(e){const t=e.rootId?document.querySelector(e.rootId):document.querySelector(".app");if(!t)throw new Error(`Laika: root element not found (${e.rootId??".app"})`);const n=function(e='[data-laika="payload"]'){const t=document.head.querySelector(e);if(!t?.textContent?.trim())throw new Error("Laika: payload missing/empty");return JSON.parse(t.textContent)}(),a={initialPayload:n,initialComponent:f(await Promise.resolve(e.resolve(n.page.component))),resolveComponent:e.resolve,...e.title?{title:e.title}:{}};return e.setup({root:t,App:b,props:a,plugin:q,payload:n})}var S=void 0;export{v as PageComponent,d as PageContent,p as ProgressBar,C as createLaikaApp,S as default,q as laikaPlugin,P as useLaika};
//# sourceMappingURL=laika.mjs.map
