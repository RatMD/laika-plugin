import{reactive as e,defineComponent as t,h as a,computed as o,shallowRef as n,ref as r,markRaw as i,Fragment as l}from"vue";const s=e({color:"#DE3163",active:!1,percent:0,timestamp:0});let u=null;function c(){function e(e=!1){u&&(window.clearInterval(u),u=null),(s.active||e)&&(s.percent=100,window.setTimeout(()=>{s.active=!1,s.percent=0},150))}return{state:s,start:function(){s.active=!0,s.percent=10,s.timestamp=Date.now(),u&&window.clearInterval(u),u=window.setInterval(()=>{s.active&&s.percent<90&&(s.percent+=Math.max(1,Math.round(.08*(90-s.percent))))},200)},done:e,fail:function(){e(!0)}}}const p=t({setup(e){const t=c();return()=>t.state.active?a("div",{class:"laika-progress-bar",style:{top:0,left:0,width:`${t.state.percent}%`,height:"0.2rem",position:"fixed",backgroundColor:`var(--laika-progress-bar, ${t.state.color})`,transition:"width 120ms linear",zIndex:99999}}):void 0}}),d=t({setup(e){const t=L();return()=>{const e=t.page?.content??"";return a("div",{innerHTML:e})}}}),v=t({props:{name:{type:String,required:!0}},slots:Object,setup(e,{slots:t}){const o=L();return()=>{if(!o.components||!(e.name in o.components))return null;const n=o.components[e.name]||void 0;if(!n)return null;const r=t.default?.({...n});return a("div",{},r??void 0)}}});function m(e){return e?.default??e}const y=n(),f=n(),w=n(null),g=r(void 0),h={payload:()=>{},page:()=>{},visit:async()=>{throw new Error("Laika runtime not ready")},request:async()=>{throw new Error("Laika runtime not ready")}},k=t({name:"Laika",props:{initialPayload:{type:Object,required:!0},initialComponent:{type:Object,required:!1},resolveComponent:{type:Function,required:!0},title:{type:Function,required:!1,default:e=>e}},setup({initialPayload:e,initialComponent:t,resolveComponent:o,title:n}){f.value=e,g.value=void 0;const r=c();return y.value=t?i(m(t)):void 0,y.value||Promise.resolve(o(e.component)).then(e=>{y.value=i(m(e))}).catch(console.error),h.payload=()=>f.value,h.page=()=>f.value?.page,h.visit=async(e,t)=>{r.start();try{t?.replace?history.replaceState({},"",e):history.pushState({},"",e);const a=await async function(e){const t=await fetch(e,{headers:{Accept:"application/json","X-Laika":"1","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(console.log(t,e),409===t.status){const e=t.headers.get("X-Laika-Location");throw e&&window.location.assign(e),new Error("Laika redirect")}if(!t.ok)throw window.location.assign(e),new Error("Navigation fallback");return await t.json()}(e);await async function(e,t){const a=await o(e.component);y.value=i(m(a)),f.value=e;const r=e.page.head?.title;r&&(document.title=(n??(e=>e))(r)),g.value=t?g.value:Date.now()}(a,t?.preserveState),r.done()}catch(e){console.error(e),r.fail()}},h.request=async(e,t)=>({handler:e,data:t}),h.setLayout=e=>{w.value=e},window.addEventListener("popstate",()=>window.location.reload()),()=>{if(!y.value||!f.value)return null;const e=f.value.pageProps??{},t=a(y.value,{...e,key:g.value});let o;w.value&&(y.value.layout=w.value,w.value=null);const n=y.value.layout;if(n)if("function"==typeof n)o=n(a,t);else{o=(Array.isArray(n)?n:[n]).slice().reverse().reduce((t,o)=>a(o,{...e},()=>t),t)}else o=t;return a(l,null,[a(p),o])}}}),P={install(e){Object.defineProperty(e.config.globalProperties,"$laika",{get:()=>h}),Object.defineProperty(e.config.globalProperties,"$payload",{get:()=>f.value})}};function L(){return e({component:o(()=>y.value),layout:o(()=>w.value),key:o(()=>g.value),payload:o(()=>f.value),version:o(()=>f.value?.version),page:o(()=>f.value?.page),pageProps:o(()=>f.value?.pageProps),sharedProps:o(()=>f.value?.sharedProps),theme:o(()=>f.value?.theme),components:o(()=>f.value?.components),fragments:o(()=>f.value?.fragments),redirect:o(()=>f.value?.redirect),runtime:o(()=>h)})}async function q(e){const t=e.rootId?document.querySelector(e.rootId):document.querySelector(".app");if(!t)throw new Error(`Laika: root element not found (${e.rootId??".app"})`);const a=function(e='[data-laika="payload"]'){const t=document.head.querySelector(e);if(!t?.textContent?.trim())throw new Error("Laika: payload missing/empty");return JSON.parse(t.textContent)}(),o={initialPayload:a,initialComponent:m(await Promise.resolve(e.resolve(a.component))),resolveComponent:e.resolve,...e.title?{title:e.title}:{}};return e.setup({root:t,App:k,props:o,plugin:P,payload:a})}var b=void 0;export{v as PageComponent,d as PageContent,p as ProgressBar,q as createLaikaApp,b as default,P as laikaPlugin,L as useLaika};
//# sourceMappingURL=laika.mjs.map
